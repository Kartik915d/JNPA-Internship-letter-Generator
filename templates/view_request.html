<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>View Request – {{ student_name or req_id }}</title>

  <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/Fjnpa_logo.png') }}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    * { box-sizing: border-box; }
    
    body { 
      padding: 12px; 
      background: #f8f9fa;
      font-family: Arial, sans-serif;
    }
    
    .card { 
      box-shadow: 0 4px 10px rgba(0,0,0,0.04);
      margin-bottom: 1.5rem;
    }
    
    .meta { 
      font-size: .95rem; 
      color: #444;
      margin-bottom: 0.5rem;
    }
    
    .field-label { 
      font-weight: 600; 
      color: #222; 
    }
    
    .file-preview { 
      border: 1px solid #e5e7eb; 
      border-radius: 6px; 
      padding: 12px; 
      background: #fff; 
    }
    
    .small-note { 
      font-size: .85rem; 
      color: #666; 
    }
    
    .iframe-wrap { 
      height: 520px;
      margin-top: 1rem;
    }

    .card-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }

    /* Back button styling */
    .back-btn {
      margin-bottom: 1.5rem;
    }

    /* Responsive button sizing */
    .btn-sm {
      font-size: 0.875rem;
    }

    /* Mobile optimizations */
    @media (max-width: 768px) {
      body {
        padding: 8px;
      }

      .card {
        margin-bottom: 1rem;
      }

      .card-body {
        padding: 1rem;
      }

      .card-title {
        font-size: 1rem;
      }

      .meta {
        font-size: 0.9rem;
        margin-bottom: 0.4rem;
      }

      .row {
        margin: -0.5rem;
      }

      .col-md-6 {
        padding: 0.5rem;
      }

      .btn {
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
      }

      .btn-sm {
        padding: 0.4rem 0.6rem;
        font-size: 0.8rem;
      }

      .file-preview {
        padding: 10px;
      }

      .iframe-wrap {
        height: 350px;
      }

      h2 {
        font-size: 1.3rem;
      }

      h5 {
        font-size: 1rem;
      }

      h6 {
        font-size: 0.95rem;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 6px;
      }

      .card {
        margin-bottom: 0.8rem;
      }

      .card-body {
        padding: 0.75rem;
      }

      .card-title {
        font-size: 0.95rem;
      }

      .meta {
        font-size: 0.85rem;
        margin-bottom: 0.3rem;
      }

      .small-note {
        font-size: 0.8rem;
      }

      .btn {
        padding: 0.4rem 0.6rem;
        font-size: 0.8rem;
      }

      .btn-sm {
        padding: 0.35rem 0.5rem;
        font-size: 0.75rem;
      }

      .file-preview {
        padding: 8px;
      }

      .iframe-wrap {
        height: 280px;
      }

      h2 {
        font-size: 1.1rem;
      }

      h5 {
        font-size: 0.95rem;
      }

      h6 {
        font-size: 0.9rem;
      }

      .list-unstyled li {
        margin-bottom: 0.3rem;
      }
    }
  </style>
</head>

<body>
<div class="container-fluid">

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="my-3">
        {% for cat, msg in messages %}
          <div class="alert alert-{{ 'success' if cat=='success' else ('danger' if cat=='danger' else 'info') }} alert-dismissible fade show" role="alert">
            {{ msg }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- Page Heading -->
  <div class="d-flex flex-wrap align-items-center mb-3 back-btn">
    <a class="btn btn-outline-secondary btn-sm me-2" href="{{ url_for('admin_dashboard') }}">← Back</a>
    <h2 class="mb-0">{{ student_name or req_id }}</h2>
  </div>

  <div class="row">
    <!-- LEFT SIDE (Main Content) -->
    <div class="col-lg-8">

      <!-- Student Details -->
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Student Details</h5>

          <div class="row g-2">
            <div class="col-12 col-md-6">
              <div class="meta"><span class="field-label">Name:</span> {{ student_name or '-' }}</div>
              <div class="meta"><span class="field-label">Email:</span> {{ email or '-' }}</div>
              <div class="meta"><span class="field-label">College:</span> {{ college or '-' }}</div>
              <div class="meta"><span class="field-label">Year / Branch:</span> {{ year or '-' }} / {{ branch or '-' }}</div>
            </div>

            <div class="col-12 col-md-6">
              <div class="meta"><span class="field-label">Start Date:</span> {{ start_date or '-' }}</div>
              <div class="meta"><span class="field-label">End Date:</span> {{ end_date or '-' }}</div>
              <div class="meta"><span class="field-label">Duration:</span> {{ duration or '-' }}</div>
              <div class="meta"><span class="field-label">Submitted:</span> {{ submission or '-' }}</div>
              <div class="meta"><span class="field-label">Status:</span>
                <strong>{{ status or 'Pending' }}</strong>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Permission Letter -->
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Permission / Uploaded Document</h5>

          {% if permission_filename %}
            <div class="file-preview">

              <div class="row align-items-start">
                <div class="col-12 col-sm-6 mb-3 mb-sm-0">
                  <div><strong>{{ permission_filename }}</strong></div>
                  <!-- <div class="small-note">Stored path: {{ permission_filename }}</div> -->
                </div>

                <div class="col-12 col-sm-6">
                  <div class="d-grid gap-2 d-sm-flex gap-sm-2 justify-content-sm-end">
                    <a class="btn btn-outline-primary btn-sm"
                       href="{{ url_for('uploaded_file', filename=permission_filename) }}"
                       target="_blank">Open</a>

                    <a class="btn btn-outline-secondary btn-sm"
                       href="{{ url_for('uploaded_file', filename=permission_filename) }}"
                       download>Download</a>
                  </div>
                </div>
              </div>

              {% if permission_filename.lower().endswith('.pdf') %}
                <div class="iframe-wrap">
                  <iframe src="{{ url_for('uploaded_file', filename=permission_filename) }}"
                          style="width:100%; height:100%; border:0;"
                          title="Permission PDF"></iframe>
                </div>
              {% endif %}

            </div>

          {% else %}
            <div class="alert alert-warning mb-0">No uploaded permission file found for this request.</div>
          {% endif %}
        </div>
      </div>

      <!-- Internship Letter -->
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Generated Internship Letter</h5>

          {% set st = (status or '').lower() %}

          {% if st == 'approved' %}
            <p class="small-note mb-3">This request is approved. You can download or open the generated internship letter below.</p>

            <div class="d-grid gap-2 d-md-flex gap-md-2">
              <a class="btn btn-outline-primary"
                 href="{{ url_for('download_letter', req_id=req_id) }}"
                 target="_blank">Download Letter (PDF)</a>

              {% if generated_filename %}
                <a class="btn btn-outline-secondary"
                   href="{{ url_for('serve_generated', filename=generated_filename) }}"
                   target="_blank">Open Letter</a>
              {% endif %}
            </div>

          {% elif st == 'pending' %}
            <p class="small-note mb-3">No letter is available yet. Approve the request to generate the internship letter.</p>
            <form method="post" action="{{ url_for('admin_approve', req_id=req_id) }}" class="d-inline">
              <button type="submit" class="btn btn-success btn-sm">Approve & Generate</button>
            </form>

          {% else %}
            <div class="alert alert-secondary mb-0">
              This request has been <strong>rejected</strong>. No internship letter will be generated.
            </div>
          {% endif %}

        </div>
      </div>

    </div> <!-- /.col -->

    <!-- RIGHT SIDE (Admin Actions) -->
    <div class="col-lg-4">

      <div class="card">
        <div class="card-body">
          <h6 class="card-title">Admin Actions</h6>

          <form method="post" action="{{ url_for('admin_approve', req_id=req_id) }}" class="mb-2">
            <button type="submit" class="btn btn-success w-100">Approve</button>
          </form>

          <form method="post" action="{{ url_for('admin_reject', req_id=req_id) }}" class="mb-2">
            <button type="submit" class="btn btn-danger w-100">Reject</button>
          </form>

          <a class="btn btn-secondary w-100 mb-3" href="{{ url_for('admin_dashboard') }}">Back to Dashboard</a>

          <hr>

          <h6>Quick Info</h6>
          <ul class="list-unstyled small-note">
            <li><strong>Request ID:</strong> {{ req_id }}</li>
            <li><strong>Submitted:</strong> {{ submission or '-' }}</li>
            <li><strong>Current Status:</strong> {{ status or '-' }}</li>
          </ul>
        </div>
      </div>

    </div><!-- /.col -->
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>